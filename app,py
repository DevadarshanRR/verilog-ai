from flask import Flask, render_template, request
from groq import Groq
import os

app = Flask(__name__)

# Get API key from environment variable
GROQ_API_KEY = os.getenv("GROQ_API_KEY")

if not GROQ_API_KEY:
    raise ValueError("GROQ_API_KEY environment variable not set")

client = Groq(api_key=GROQ_API_KEY)


def generate_verilog(description):
    prompt = f"""
You are an expert RTL hardware design engineer.

Rules:
- Generate synthesizable Verilog-2001 code.
- Include proper module definition.
- Clearly define inputs and outputs.
- Do NOT include explanation.
- Output only Verilog code.

Specification:
{description}
"""

    response = client.chat.completions.create(
        model="llama-3.1-8b-instant",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.2
    )

    result = response.choices[0].message.content

    # Clean formatting (remove ``` blocks if present)
    if "```" in result:
        parts = result.split("```")
        if len(parts) >= 2:
            result = parts[1]

    return result.strip()


@app.route("/", methods=["GET", "POST"])
def home():
    verilog_code = ""
    error_message = ""

    if request.method == "POST":
        description = request.form.get("description")

        if description:
            try:
                verilog_code = generate_verilog(description)
            except Exception as e:
                error_message = str(e)
        else:
            error_message = "Please enter a hardware specification."

    return render_template(
        "index.html",
        verilog_code=verilog_code,
        error_message=error_message
    )


if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
